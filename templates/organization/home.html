{% extends "common-content.html" %}

{% block content_js_media %}
    <script type="text/javascript">
        $(function () {
            $('.leave-organization').click(function () {
                return confirm('{{ _("Are you sure you want to leave this organization?") }}\n' +
                    {% if organization.is_open %}
                        '{{ _("You will have to rejoin to show up on the organization leaderboard.") }}'
                    {% else %}
                        '{{ _("You will have to request membership in order to join again.") }}'
                    {% endif %}
                );
            });
        });
        
    {% if request.user.is_authenticated and request.profile in organization %}
        function make_message(data) {
            const user = data.user
            const msg = data.msg
            const publish = moment(data.publish).format('MMMM Do YYYY, h:mm a')
            const avatar = data.avatar
            const css_class = data.class
            const name = data.name

            var description = document.getElementById('messages')
            const message = document.getElementById('empty_comment').cloneNode(true)
            message.classList.remove('hidden')
            message.innerHTML = message.innerHTML.replace(/__user_page__/g, {{ url('user_page') + '/' }} + user)
            message.innerHTML = message.innerHTML.replace(/__css_class__/g, css_class)
            message.innerHTML = message.innerHTML.replace(/__name__/g, name)
            message.innerHTML = message.innerHTML.replace(/__msg__/g, msg)
            message.innerHTML = message.innerHTML.replace(/__publish_on__/g, publish)
            message.getElementsByTagName('img')[0].src = avatar
            description.append(message)
            const messages = document.getElementById('description');
            messages.scrollTop = messages.scrollHeight;
        }
        function send_message() {
            const data = {
                user                : window.user.id,
                msg                 : document.getElementById('message').value,
                org                 : {{ organization.pk }},
                csrfmiddlewaretoken : $.cookie('csrftoken')
            }
            if (data.msg.length == 0) return
            $.ajax({
                type    : 'POST',
                url     : '{{ url("chat:send_message") }}',
                data    : data,
                success : function(response) {
                    $('#message').val('')
                }
            })
        }
        {% if EVENT_LAST_MSG %}
        $(function () {
            var blocked = false, request = false;

            function update() {
                if (blocked) {
                    request = true;
                    return;
                }
                request = false;
                blocked = true;
                $.ajax({
                    url: '{{ url('new_messages') }}',
                    data: {
                        id: '{{ msg[0].id }}',
                        org: '{{ organization.id }}'
                    }
                }).done(function (data) {
                    console.log(data)
                    setTimeout(function () {
                        blocked = false;
                        if (request)
                            update();
                    }, 500);
                }).fail(function (data) {
                    console.log('Failed to update testcases!');
                });
            }
            event_dispatcher.on('messages_{{ organization.room.id }}', function (message) {
                console.log(1)
                update()
            })
        });
        {% endif %}
    {% endif %}
    </script>
{% endblock %}

{% block content_media %}
<style>
    .msg p {
        word-wrap: break-word;
        word-break: break-word;
    }
    .hidden {
        display: none;
    }
</style>
{% endblock content_media %}

{% block info_float %}
    {% if request.user.is_authenticated %}
        {% if request.profile in organization %}
            <form method="post" action="{{ url('leave_organization', organization.id, organization.slug) }}">
                {% csrf_token %}
                <input type="submit" class="unselectable button full leave-organization" value="{{ _('Leave organization') }}">
            </form>
        {% elif organization.is_open %}
            <form method="post" action="{{ url('join_organization', organization.id, organization.slug) }}">
                {% csrf_token %}
                <input type="submit" class="unselectable button full" value="{{ _('Join organization') }}">
            </form>
        {% else %}
            <a href="{{ url('request_organization', organization.id, organization.slug) }}"
               class="unselectable button full">{{ _('Request membership') }}</a>
        {% endif %}
        <hr>
    {% endif %}

    {% if can_edit %}
        <div><a href="{{ url('edit_organization', organization.id, organization.slug) }}">{{ _('Edit organization') }}</a></div>

        {% if not organization.is_open %}
            <div>
                <a href="{{ url('organization_requests_pending', organization.id, organization.slug) }}">{{ _('View requests') }}</a>
            </div>
        {% endif %}

        {% if perms.judge.add_contest %}
            <div>
                <a href="{{ url('admin:judge_contest_add') }}">{{ _('Create contest') }}</a>
            </div>
        {% endif %}
    {% endif %}

    {% if perms.judge.change_organization %}
        <div>
            <a href="{{ url('admin:judge_organization_change', organization.id) }}">{{ _('Admin organization') }}</a>
        </div>
    {% endif %}

    <div>
        <a href="{{ organization.get_users_url() }}">{{ _('View members') }}</a>
    </div>
{% endblock %}

{% block description %}
<div class="ui fluid container">
    <div class="ui segment">
        {% cache 3600 'organization_html' organization.id MATH_ENGINE %}
            {{ organization.about|markdown('organization-about', MATH_ENGINE)|reference|str|safe }}
        {% endcache %}
    </div>
    {% if request.user.is_authenticated and request.profile in organization %}
    <div class="ui top attached secondary inverted black menu">
        <h3 class="ui item header">{{ organization.room }}</h3>
    </div>
    <div class="ui bottom attached segments">
        <div class="ui segment" id="description" style="overflow-x: auto; max-height: 50em;">
            <div class="ui comments" style="max-width: unset" id="messages">
                <div class="ws-closed">
                    <a href="javascript:void(0)">{{ _('You were disconnected. Refresh to show latest updates.') }}</a>
                </div>
                <div class="comment hidden" id="empty_comment">
                    <a href="__user_page__" class="avatar"><img></a>
                    <div class="content">
                        <a href="__user_page__" class="author">
                            <span class="__css_class__">
                                __name__
                            </span>
                        </a>
                        <div class="metadata">
                            __publish_on__
                        </div>
                        <div class="text">
                            __msg__
                        </div>
                        <div class="action"></div>
                    </div>
                </div>
            {% for message in msg|reverse %}
                <div class="comment">
                    <a href="{{ url('user_page', message.user.user.user.username) }}" class="avatar">
                        <img src="{{ gravatar(message.user.user) }}">
                    </a>
                    <div class="content">
                        {{ link_user(message.user.user) }}
                        <div class="metadata">
                            {{ message.publish_on|date(_("N j, Y, g:i a")) }}
                        </div>
                        <div class="text">
                            {% cache 3600 'message_html' message.id %}
                            {{ message.msg|markdown('comment') }}
                            {% endcache %}
                        </div>
                        <div class="action"></div>
                    </div>
                </div>
            {% endfor %}
            </div>
        </div>
        <div class="ui segment">
            <form class="ui form" method="post" action="">
                <div class="field">
                    <label for="message">Message</label>
                    <textarea name="msg" id="message" rows="2"></textarea>
                </div>
                <div class="field">
                    <a class="ui primary button" onclick="send_message()">Send</a>
                </div>
            </form>
        </div>
    </div>
    {% endif %}
</div>
{% if request.user.is_authenticated and request.profile in organization %}
<script>
    const messages = document.getElementById('description');
    messages.scrollTop = messages.scrollHeight;
</script>
{% endif %}
{% endblock %}
